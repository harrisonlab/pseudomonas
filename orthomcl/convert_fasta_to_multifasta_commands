# Recombination program ClonalFrameML requires xmfa file input with locations of each gene in each genome to infer where recombination has occured

## Commands to convert fasta file of each orthogroup into a multifasta xmfa file 
## Each protein ID is replaced with >protein: start-end strand 
## This will allow me to use the fasta files used for whole genome core orthogroup phylogeny into the recombination analysis program ClonalFrameML
## Final multifasta (xmfa) file will consist of each orthogroup alignment separated with "=" 

# Pre-processing of gff file to edit name to include "|" - this prevents strains like 2339 grep picking up other genome peg.2339

for gff in  /home/hulinm/gff/*.gff2 ; do 
strain=$(basename $gff | sed s/".gff2"//g) 
cp $gff "$strain""|".gff3 
done


# Process gff to get locations and strand into file called strain locations
for gff in /home/hulinm/gff/*.gff3 ; do 
strain=$(basename $gff | sed s/".gff3"//g) 
strain_short=$(basename $gff | sed s/"|.gff3"//g) 
sed s/ID=fig"|"[0-9]*.[0-9]*./"$strain"/g $gff | sed s/";"/"\t"/g | tail -n +2  > /home/hulinm/gff/"$strain"
echo $gff

mkfifo /home/hulinm/gff/pipe1
mkfifo /home/hulinm/gff/pipe2
mkfifo /home/hulinm/gff/pipe3
mkfifo /home/hulinm/gff/pipe4
cut -f9 /home/hulinm/gff/"$strain" > /home/hulinm/gff/pipe1 & 
cut -f4 /home/hulinm/gff/"$strain" > /home/hulinm/gff/pipe2 &
cut -f5 /home/hulinm/gff/"$strain" > /home/hulinm/gff/pipe3 &
cut -f7 /home/hulinm/gff/"$strain" > /home/hulinm/gff/pipe4 &
paste /home/hulinm/gff/pipe1  > /home/hulinm/gff/"$strain_short"_locations
awk '{print ">"$1 }' /home/hulinm/gff/"$strain_short"_locations >  /home/hulinm/gff/"$strain_short".tmp 
paste /home/hulinm/gff/pipe2 /home/hulinm/gff/pipe3 > /home/hulinm/gff/locations 
sed s/"\t"/"-"/g /home/hulinm/gff/locations > /home/hulinm/gff/locations.tmp

paste /home/hulinm/gff/"$strain_short".tmp /home/hulinm/gff/locations.tmp /home/hulinm/gff/pipe4 > /home/hulinm/gff/"$strain_short"_locations

sed -i s/pssavastanoi"|"peg/pssavastanoi"|".peg/g /home/hulinm/gff/"$strain_short"_locations #Need to edit pssavastanoi due to wrongly placed .
 
rm /home/hulinm/gff/pipe*
rm /home/hulinm/gff/*.tmp
rm /home/hulinm/gff/locations

#  Take core orthogroup fasta files and replace strain ID with strain ID + location of gene 
for fasta in ./*.fasta ; do
fastafile=$(basename $fasta | sed s/".fasta"//g) 
ID=$(grep $strain $fasta) 
echo $ID
locations=$(grep -w "$ID" /home/hulinm/gff/"$strain_short"_locations)
#echo $locations

# Replacement 
sed -i s/"$ID"/"$locations"/g $fasta 





# Concatenate all fasta into xmfa file 

awk 'FNR==1 && NR!=1 {print "="}{print}' * > xmfa










